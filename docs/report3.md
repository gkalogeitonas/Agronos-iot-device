# Αναφορά 3

**Φοιτητής:** Καλογείτονας Γεωργιος

**Επιβλέπων Καθηγητής:** Νικόλαος Σκλάβος

**Ημερομηνία:** Δεκέμβριος 2025

---

## Περίληψη

Η παρούσα αναφορά εστιάζει αποκλειστικά στο υποσύστημα των IoT κόμβων (Device Nodes) της πλατφόρμας **Agronos**. Περιγράφει την αρχιτεκτονική του υλικολογισμικού (firmware) που αναπτύχθηκε για τον μικροελεγκτή ESP32, τις μεθόδους επικοινωνίας και τη στρατηγική "Smart Routing" για την αξιόπιστη αποστολή δεδομένων.

Η υλοποίηση του firmware βασίζεται στο **PlatformIO** και στη γλώσσα **C++**, ακολουθώντας αντικειμενοστραφή σχεδίαση για ευελιξία και επεκτασιμότητα.

## Αρχιτεκτονική Υλικολογισμικού (Firmware Architecture)

Το λογισμικό της συσκευής έχει σχεδιαστεί με αρθρωτή (modular) αρχιτεκτονική, διαχωρίζοντας τις ευθύνες σε διακριτά υποσυστήματα.

### Κύρια Συστατικά (Components)

1.  **Sensor Abstraction Layer**:
    *   Χρήση του προτύπου σχεδίασης **Factory Pattern** (`SensorFactory`) για τη δυναμική δημιουργία αντικειμένων αισθητήρων βάσει των ρυθμίσεων (`config.h`).
    *   Όλοι οι αισθητήρες κληρονομούν από τη βασική κλάση `SensorBase`, επιτρέποντας την ομοιόμορφη διαχείριση διαφορετικών τύπων αισθητήρων (π.χ. DHT11, Soil Moisture).
    *   Υλοποίηση μηχανισμού διαμοιρασμού πόρων (`dht_shared`) για αισθητήρες που μοιράζονται το ίδιο φυσικό pin (π.χ. θερμοκρασία και υγρασία από το ίδιο DHT11).

2.  **AuthManager**:
    *   Υπεύθυνος για την αυθεντικοποίηση της συσκευής με το backend.
    *   Διαχειρίζεται τον κύκλο ζωής του **JWT (JSON Web Token)**, ανανεώνοντας το όταν λήξει ή όταν η συσκευή επανεκκινεί.

3.  **DataSender (Smart Router)**:
    *   Ο πυρήνας της λογικής αποστολής δεδομένων.
    *   Κατασκευάζει τα JSON payloads με τις μετρήσεις.
    *   Αποφασίζει δυναμικά ποιο πρωτόκολλο θα χρησιμοποιηθεί (MQTT ή HTTP) βάσει διαθεσιμότητας και ρυθμίσεων.

4.  **Storage (NVS)**:
    *   Διαχειρίζεται τη μόνιμη μνήμη (Non-Volatile Storage) του ESP32.
    *   Αποθηκεύει κρυπτογραφημένα τα διαπιστευτήρια WiFi, το JWT token και τα διαπιστευτήρια MQTT.

## Διαδικασία Provisioning & Authentication

Η διαδικασία ένταξης μιας νέας συσκευής στο δίκτυο (Provisioning) είναι πλήρως αυτοματοποιημένη και ασφαλής.

### Βήμα 1: WiFi Provisioning (Captive Portal)
Εάν η συσκευή δεν έχει αποθηκευμένα στοιχεία σύνδεσης WiFi, ενεργοποιεί αυτόματα ένα Access Point (AP) με όνομα `ESP_Config`. Ο χρήστης συνδέεται σε αυτό και μέσω μιας ιστοσελίδας (Captive Portal) εισάγει το SSID και τον κωδικό του δικτύου του.

### Βήμα 2: Device Login (HTTP)
Μόλις η συσκευή συνδεθεί στο διαδίκτυο, εκτελεί ένα HTTP POST αίτημα στο `/api/v1/device/login` χρησιμοποιώντας το μοναδικό `UUID` και `Secret` της. Το backend επιστρέφει ένα JWT token, το οποίο αποθηκεύεται τοπικά.

### Βήμα 3: MQTT Credential Provisioning
Εφόσον το MQTT είναι ενεργοποιημένο (`MQTT_ENABLED = true`), η συσκευή χρησιμοποιεί το JWT token για να ζητήσει τα ειδικά διαπιστευτήρια MQTT (Broker URL, Username, Password) από το backend. Αυτά τα στοιχεία είναι δυναμικά και αποθηκεύονται στη μνήμη NVS, ώστε η συσκευή να μπορεί να συνδέεται απευθείας στον Broker σε επόμενες εκκινήσεις.

## Στρατηγική Επικοινωνίας: Smart Routing

Για να εξασφαλιστεί η μέγιστη αξιοπιστία και εξοικονόμηση ενέργειας, η συσκευή υλοποιεί μια υβριδική στρατηγική επικοινωνίας.

### Ροή Απόφασης (Decision Flow)

1.  **Συλλογή Δεδομένων**: Η συσκευή ξυπνά από Deep Sleep, διαβάζει τους αισθητήρες και δημιουργεί το πακέτο δεδομένων.
2.  **Προσπάθεια MQTT (Προτιμώμενο)**:
    *   Η συσκευή ελέγχει αν έχει αποθηκευμένα διαπιστευτήρια MQTT.
    *   Επιχειρεί σύνδεση στον MQTT Broker (θύρα 1883 ή 8883 για TLS).
    *   Δημοσιεύει τα δεδομένα στο θέμα `devices/{uuid}/sensors` με **QoS 1** (At least once).
3.  **HTTP Fallback (Εφεδρικό)**:
    *   Εάν η σύνδεση MQTT αποτύχει ή δεν υπάρχουν διαπιστευτήρια, το `DataSender` μεταπίπτει αυτόματα σε HTTP λειτουργία.
    *   Στέλνει τα δεδομένα μέσω HTTP POST στο `/api/v1/device/data` χρησιμοποιώντας το JWT για αυθεντικοποίηση.

Αυτή η προσέγγιση συνδυάζει την ταχύτητα και το χαμηλό overhead του MQTT με την καθολική συμβατότητα και αξιοπιστία του HTTP ως δικλείδα ασφαλείας.

## Διαχείριση Ενέργειας (Deep Sleep)

Λόγω της φύσης των γεωργικών εφαρμογών (απομακρυσμένα σημεία, πιθανή χρήση μπαταρίας), η συσκευή έχει βελτιστοποιηθεί για χαμηλή κατανάλωση.

*   Μετά από κάθε κύκλο μέτρησης και αποστολής, η συσκευή εισέρχεται σε κατάσταση **Deep Sleep**.
*   Όλα τα περιφερειακά (WiFi, Bluetooth, Sensors) απενεργοποιούνται.
*   Η διάρκεια ύπνου καθορίζεται από την παράμετρο `SENSORS_READ_INTERVAL_MS` (π.χ. 2 λεπτά).
*   Η μνήμη RTC χρησιμοποιείται για τη διατήρηση κρίσιμων μετρητών μεταξύ των κύκλων ύπνου.

## Μελλοντικές Επεκτάσεις

*   **OTA Updates**: Υποστήριξη Over-The-Air αναβαθμίσεων του firmware.
*   **LoRaWAN**: Διερεύνηση ενσωμάτωσης LoRa για περιοχές χωρίς κάλυψη WiFi.
*   **Local Buffering**: Αποθήκευση μετρήσεων στην flash μνήμη όταν δεν υπάρχει καθόλου δίκτυο και μαζική αποστολή κατά την επανασύνδεση.
